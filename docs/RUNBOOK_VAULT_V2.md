# Vault v2.0 운영/배포 런북

## 1. 메타
- 문서 타입: 런북
- 버전: v0.1
- 작성일: 2025-12-20
- 대상: 운영/데브옵스/백엔드

## 2. 배포 체크리스트
- 마이그레이션 적용 (vault_status)
- 환경 변수/시크릿 확인 (DB, 알림 채널 키)
- 큐/배치 스케줄러 설정 확인
- 피처 플래그(알림/만료 배치) 기본값 확인

## 3. 배치/큐 재시도·DLQ
- 배치 실패 시 재실행: 만료 배치는 idempotent, 중복 실행 허용
- 큐 컨슈머: 지수백오프(1s,5s,30s) 5회 후 DLQ
- DLQ 처리: 15분 주기 스크럽, 원인별 재큐/폐기, 모니터링 DLQ 사이즈

## 4. 롤백 시나리오
- 애플리케이션 롤백 후에도 DB 스키마는 유지 (forward-compatible) → 필요한 경우 별도 다운그레이드 릴리스
- 알림/배치 플래그를 즉시 OFF하여 부작용 차단
- 문제가 된 배포 구간 트래픽 격리 후 재배포

## 5. 장애 대응 체크리스트
- 알림 실패 급증: 알림 채널 헬스체크, 큐 적체, DLQ 확인
- 만료 배치 미동작: 스케줄러 로그, expires_at 쿼리, 락/트랜잭션 충돌 확인
- deposit-hook 오류: tx_id 충돌, 외부 결제 지연, idempotency 재확인
- 출석 오류: 중복 출석 락 확인, 날짜 경계(UTC/로컬) 점검

## 6. 커뮤니케이션
- 장애/완료 리포트 템플릿: 영향 범위, 시작/종료 시각, 원인, 조치, 재발 방지

## 7. 운영 플래그 예시
- enable_expiry_batch (default ON in prod)
- enable_alerts (default ON in prod)
- enable_ticket_zero_modal (FE)
