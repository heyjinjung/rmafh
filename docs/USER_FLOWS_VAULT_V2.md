# USER_FLOWS_VAULT_V2

- 문서 타입: 운영/제품 시나리오
- 버전: v1.0.0
- 작성일: 2025-12-20
- 작성자: Copilot(GPT-5.2)
- 대상 독자: 운영자(텔레 상담), 기획/개발(플로우 검증)

## Changelog
- v1.0.0 (2025-12-20): 금고서비스 전체 예상 플로우/시나리오 초안 작성(유저-관리자 대화 기반)

## 요약
- 유저는 “꽁머니 문자 보고” 들어오지만, 곧바로 “금고서비스”로 전환된다.
- 골드 금고는 조건 없이 즉시 해금(첫 성공 경험/신뢰 확보).
- 플래티넘은 “연속 3일 출석 + 리뷰 키 1개”로 해금(리텐션 핵심).
- 다이아는 “누적입금 50만”으로 해금(상위 과금/고가치 전환).
- 운영은 `external_user_id` 중심으로 CSV 업로드(누적입금/텔레OK/리뷰OK 반영) + 필요 시 알림 발송(variant_id로 AB).

---

## 0) 공통 전제 (유저/운영자 머릿속)

### 용어(유저에게는 쉽게)
- 골드 금고: “오늘 바로 받을 수 있는 것(조건 없음)”
- 플래티넘 금고: “3일 연속 미션 + 리뷰 키”
- 다이아 금고: “누적입금 상위 미션”

### 상태(시스템 용어)
- LOCKED / UNLOCKED / CLAIMED / EXPIRED

### 운영 입력의 기준 ID
- 운영은 무조건 `external_user_id`로 유저를 구분한다.
  - 예: `tg_12345`, `kakao_abc`, `callcenter_001` 같은 식으로 “운영자에게 익숙한 키”

---

## 1) 유저 유입 시나리오: “꽁머니 문자 보고 왔는데요” → 금고서비스로 전환

### 시나리오 1-1: 표준 전환(가장 흔함)
- 유저: “문자 보고 왔는데요.”
- 관리자: “어떤 문자 보셨어요?”
- 유저: “꽁머니요.”
- 관리자: “아 그 이벤트는 종료됐고요. 대신 지금은 ‘금고서비스’로 진행 가능해요. 오늘 바로 해금되는 골드 금고부터 열어드릴까요?”
- 유저: “그게 뭔데요?”
- 관리자: “조건 없이 오늘 바로 해금, 외부 플랫폼에서 1만 지급되는 구조예요.”

운영/시스템 동작(예상)
- 운영자가 유저를 `external_user_id`로 등록(또는 첫 요청 시 자동 생성).
- 유저 화면에서 `/api/vault/status` 조회 → 골드는 기본 UNLOCKED로 보임.

### 시나리오 1-2: 유저가 ‘사기 아니냐’ 의심
- 유저: “조건이 없는데 왜 줘요?”
- 관리자: “골드는 ‘첫 경험’으로 바로 드리고요. 대신 플래티넘/다이아는 미션이 있어요. 해보고 마음에 들면 계속 가는 구조.”

운영 포인트
- 여기서 골드 즉시 해금 UX(한 번에 성공)가 중요.

---

## 2) 골드 금고 플로우 (조건 없음)

### 시나리오 2-1: 골드 확인 → 바로 회수(Claim)
- 유저 화면: “골드 금고: 해금됨 / 바로 회수 가능”
- 유저 행동: “회수하기” 클릭
- 시스템: gold_status = CLAIMED 처리
- 결과: 외부플랫폼 지급(1만)

예상 이탈/리텐션 장치
- 골드는 끝. 바로 플래티넘을 ‘다음 목표’로 보여줘야 함.
  - “내일 출석 1/3부터 시작하면 플래티넘에 가까워짐” 같은 톤

### 시나리오 2-2: 골드 ‘안 받음’
- 유저: “나중에 받을게요”
- 시스템: gold_status는 UNLOCKED 유지
- 리텐션: 플래티넘/다이아 진행 패널이 계속 보이게 설계

---

## 3) 플래티넘 금고: 강한 리텐션 핵심 플로우

정책
- 해금 조건: “연속 3일(각 일자 5만원 이상 입금) + 리뷰 1회 이상(review_ok)”
- 금액: 2만원

### 3-A) 유저가 화면에서 보는 ‘미션’
- 출석(연속 3일) 진행도: 0/3, 1/3, 2/3, 3/3
- 리뷰 키: 0/1 또는 1/1
- 메시지 톤(핵심):
  - “연속이 끊기면 0으로 리셋”
  - “내일 한 번만 더 하면 끝(near-miss)”
  - “지금 멈추면 소멸(손실 프레이밍)”

### 시나리오 3-1: Day 1 시작(5만원 충족)
- 유저: “플래티넘 하고 싶은데 뭐하면 돼요?”
- 관리자: “오늘부터 3일 연속으로 ‘하루 5만 이상’만 채우면 돼요. 근데 연속이라 중간에 끊기면 처음부터.”

시스템 동작
- 운영 CSV 업로드로 deposit_total 증가가 반영됨
- `/api/vault/user-daily-import` 처리 시
  - 해당 날짜 deposit_delta >= 50,000이면 attendance_days +1
  - 아니면 attendance_days = 0 (리셋)

### 시나리오 3-2: 같은 날 “출석이 2번 올라가요?”(유저/운영자 착각)

결론부터
- 이 서비스의 플래티넘 “연속 3일”은 **유저가 버튼 눌러서 찍는 출석이 아니라**, **어드민 CSV 업로드(입금 데이터)로 자동 계산되는 출석**이 기본이에요.
  - 즉, 유저가 새로고침을 많이 하거나 화면을 여러 번 눌러도 “출석 2번”이 되지는 않아요.

현장 대화(유저)
- 유저: “저 오늘 한 거 맞아요? 계속 눌러도 되나요?”
- 관리자: “눌러도 출석이 중복으로 올라가진 않아요. 오늘 조건 충족이면 1/3로 유지되고, 내일 조건 채우면 2/3로 올라가요.”

현장 대화(운영자)
- 운영자: “오늘 CSV를 두 번 올렸는데 출석이 2번 올라가요?”
- 정리: 같은 날짜/같은 누적 기준으로는 **중복 반영이 안 되도록** 처리돼요(이미 오늘로 처리된 건 다시 카운트하지 않음).

참고(개발/운영)
- `/api/vault/attendance` 엔드포인트는 “수동 출석(데모/QA)” 성격이고, 운영 기본 플로우(입금 기반 연속일수)는 `/api/vault/user-daily-import` 쪽이에요.
- 만약 수동 출석을 노출/사용하는 경우에만, 같은 날짜에 두 번 호출하면 409 `ALREADY_ATTENDED`가 뜰 수 있어요.

### 시나리오 3-3: Day 2(연속 유지)
- 유저: “나 2일차 맞죠?”
- 관리자: “맞아요. 지금 2/3. 내일 한 번만 더 하면 해금 조건 거의 끝이에요.”

### 시나리오 3-4: Day 3인데 리뷰가 없음(near-miss 최대)
- 유저: “3일 다 했는데 왜 잠겨있어요?”
- 관리자: “리뷰 키 1개가 있어야 마지막 해금이 돼요. 리뷰만 확인되면 바로 열려요.”

시스템 동작
- attendance_days == 3 이지만 review_ok == false
- platinum_status는 LOCKED 유지

### 시나리오 3-5: Day 3 + 리뷰OK → 즉시 해금
- 유저: “리뷰 남겼는데요?”
- 관리자: “확인됐어요. 지금 플래티넘 열릴 거예요.”

시스템 동작
- 운영 CSV 업로드에서 review_ok=true 반영
- 다음 status 조회 또는 import 처리 시 platinum_status = UNLOCKED

### 시나리오 3-6: 연속이 끊김(리셋 공포)
- 유저: “어제 못했어요… 어떡해요?”
- 관리자: “연속이라 0으로 리셋돼요. 대신 오늘 다시 1/3부터 재시작 가능해요.”

시스템 동작
- 특정 날짜 deposit_delta < 50,000 또는 누락으로 판단되면 attendance_days = 0

---

## 4) 다이아 금고: 고가치 전환 플로우

정책
- 해금 조건: 누적입금 500,000 이상

### 시나리오 4-1: 누적이 쌓이는 유저
- 유저: “다이아는 뭔데요?”
- 관리자: “누적 50만 넘으면 열려요. 지금 누적이 어디까지 왔는지 화면에서 바로 보이게 되어 있어요.”

시스템 동작
- 운영 CSV 업로드로 deposit_total 누적 반영
- `/api/vault/user-daily-import` 또는 status 계산에서 diamond 조건 체크

### 시나리오 4-2: 49만 → 50만(near-miss)
- 유저: “나 거의 다 했는데?”
- 관리자: “지금 49만이면 내일 1만만 더 하면 해금이에요.”

---

## 5) 만료/시간 제한 플로우(공포/긴급성)

### 시나리오 5-1: 만료가 임박해서 유저가 흔들림
- 유저: “나 오늘 못하면 끝나요?”
- 관리자: “만료까지 남은 시간 안에만 하면 돼요. 지금 진행해두면 소멸 안 시킬 수 있어요.”

시스템 동작
- `/api/vault/status`에서 expires_at 기반 remaining_ms 계산
- FE는 countdown 표시(임박 시 강조)

---

## 6) 운영(관리자) 플로우: 이 프로그램으로 실제로 하는 일

### 6-1) 유저 등록/식별
- 입력: external_user_id
- 목적: 상담/정산/알림이 “그 사람” 기준으로 정확히 매칭되게

### 6-2) 일일 CSV 업로드(핵심 운영)
CSV가 반영하는 것(예상)
- 누적입금(deposit_total)
- 텔레 OK(telegram_ok)
- 리뷰 OK(review_ok)

시나리오
- 관리자: “오늘 업로드 한 번 올릴게요.”
- 시스템: `user_admin_snapshot` upsert + `vault_status` 갱신
- 결과:
  - 플래티넘 연속 일수(3일 조건)가 자동 계산됨
  - 리뷰키가 들어오면 즉시 해금 가능 상태로 변함

### 6-3) 알림 발송(AB/중복 방지)
- notify 요청에는 `type`과 `variant_id`가 있음
- variant_id 의미
  - “같은 알림이라도 문구/전략 버전(AB)”을 구분
  - 중복 방지 키(dedup_key)에 variant_id가 포함돼서 “같은 날 같은 버전”은 중복 발송 방지

운영 예시
- 관리자: “플래티넘 2/3인 애들한테 ‘내일 한 번만 더’ 버전 A 발송”
- 관리자: “리뷰 없는 3/3 애들한테 ‘리뷰 키’ 버전 B 발송”

---

## 7) 예상 에러/예외 시나리오(현장 대응 멘트까지)

### 7-1) ALREADY_ATTENDED (같은 날 재출석)
- 원인: 같은 날짜에 출석 API를 두 번 호출
- 대응 멘트: “오늘 건 이미 처리됐어요. 내일 다시 하면 2/3으로 올라가요.”

### 7-2) 잘못된 variant_id
- 원인: 허용되지 않은 variant_id로 notify 호출
- 대응: “기본(base)로 보내거나, 허용 리스트에 있는 버전만 써주세요.”

### 7-3) DB 오염으로 테스트/운영 데이터가 꼬임(개발/운영)
- 현상: 재실행 시 이전 데이터가 남아 진행도가 갑자기 높게 나옴
- 대응: 테스트에서는 TRUNCATE로 상태 초기화(이미 autouse fixture로 처리)

---

## 8) ‘리텐션 마케팅’이 실제로 작동하는 시나리오 묶음(운영자 스크립트)

### 묶음 A: 첫 성공(골드) → 다음 목표(플래티넘)
- 관리자: “골드는 오늘 바로 드리고, 플래티넘은 3일 연속만 유지하면 더 크게 열려요.”

### 묶음 B: 리셋 공포 + near-miss
- 관리자: “연속이라 끊기면 0이에요. 대신 지금 2/3이면 내일 한 번만 더 하면 끝.”

### 묶음 C: 리뷰 키 소유감
- 관리자: “리뷰는 ‘열쇠’예요. 키 1개만 확인되면 잠금이 풀려요.”

### 묶음 D: 손실 프레이밍(포기하면 소멸)
- 관리자: “지금 멈추면 여기까지 쌓인 게 소멸돼요. 오늘은 이어두는 게 이득.”

### 묶음 E: 사회적 증거
- 관리자: “지금도 이 루트로 플래티넘 회수하는 분들 많아요. 똑같이 따라오면 돼요.”

---

## 9) 체크리스트(운영자가 매일 보는)
- [ ] 오늘 CSV 업로드(누적입금/텔레OK/리뷰OK)
- [ ] 플래티넘 2/3 대상: ‘내일 한 번만 더’ 알림
- [ ] 플래티넘 3/3인데 리뷰 없는 대상: ‘리뷰 키’ 알림
- [ ] 다이아 near-miss(45만~49만): ‘1만만 더’ 알림

---

## 부록: 실제 API/관리 기능과 매핑(개발 참고)
- status 조회: `/api/vault/status`
- 출석 처리: `/api/vault/attendance` (같은 날 2번이면 ALREADY_ATTENDED)
- 일일 업로드 반영: `/api/vault/user-daily-import`
- 알림 enqueue: `/api/vault/notify` (type/variant_id + dedup)
